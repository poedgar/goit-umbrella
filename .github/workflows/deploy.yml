name: Deploy WordPress Theme

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # --- Checkout repository for reference (optional) ---
      - name: Checkout repository
        uses: actions/checkout@v4

      # --- Deploy to VPS ---
      - name: Deploy to VPS
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.HOSTINGER_HOST }}
          username: ${{ secrets.HOSTINGER_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "ğŸš€ Starting WordPress theme deployment..."

            THEME_DIR="/home/user/htdocs/srv1155173.hstgr.cloud/wp-content/themes/goit-umbrella"

            # --- SSH setup ---
            mkdir -p ~/.ssh
            ssh-keyscan github.com >> ~/.ssh/known_hosts 2>/dev/null

            # --- Fix private key permissions ---
            chmod 600 ~/.ssh/id_rsa

            # --- Remove old theme folder (fresh clone) ---
            echo "ğŸ—‘ Removing old theme folder..."
            rm -rf $THEME_DIR

            # --- Clone latest code from GitHub ---
            echo "ğŸ“¥ Cloning latest theme from GitHub..."
            git clone --depth=1 git@github.com:YOUR_USERNAME/YOUR_REPO.git $THEME_DIR
            echo "âœ… Code cloned"

            cd $THEME_DIR

            # --- Install NPM dependencies ---
            echo "ğŸ“¦ Installing NPM dependencies..."
            rm -rf node_modules
            npm install --no-audit --loglevel=error

            # --- Install Composer dependencies ---
            echo "ğŸ“¦ Installing Composer dependencies..."
            COMPOSER_ALLOW_SUPERUSER=1 composer install --no-dev --prefer-dist --no-progress --no-interaction

            # --- Build theme ---
            echo "ğŸ— Building theme..."
            npm run build

            # --- Fix permissions ---
            echo "ğŸ”§ Fixing permissions..."
            find . -type d -exec chmod 755 {} \;
            find . -type f -exec chmod 644 {} \;

            echo "ğŸ‰ Deployment completed at $(date)"
