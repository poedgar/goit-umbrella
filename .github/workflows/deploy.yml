name: Deploy WordPress Theme

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Deploy to VPS
      uses: appleboy/ssh-action@v0.1.10
      with:
        host: ${{ secrets.HOSTINGER_HOST }}
        username: ${{ secrets.HOSTINGER_USERNAME }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          #!/bin/bash
          set -e  # Exit immediately on real errors

          RED='\033[0;31m'
          GREEN='\033[0;32m'
          YELLOW='\033[1;33m'
          NC='\033[0m' # No Color

          echo -e "${GREEN}üöÄ Starting WordPress theme deployment...${NC}"

          THEME_DIR="/home/user/htdocs/srv1155173.hstgr.cloud/wp-content/themes/goit-umbrella"
          cd "$THEME_DIR"

          # --- SSH FIX ---
          mkdir -p ~/.ssh
          ssh-keyscan github.com >> ~/.ssh/known_hosts 2>/dev/null

          # --- Update code ---
          echo -e "${YELLOW}üîÑ Pulling latest code...${NC}"
          if git fetch origin && git reset --hard origin/main; then
            echo -e "${GREEN}‚úÖ Code synced${NC}"
          else
            echo -e "${RED}‚ùå Git update failed!${NC}"
            exit 1
          fi

          # --- Install NPM dependencies ---
          echo -e "${YELLOW}üì¶ Installing NPM dependencies...${NC}"
          if npm install --no-audit --loglevel=error 2> npm-warnings.log; then
            echo -e "${GREEN}‚úÖ NPM installed${NC}"
          else
            echo -e "${RED}‚ùå NPM install failed! Check npm-warnings.log${NC}"
            exit 1
          fi

          # --- Install Composer dependencies ---
          echo -e "${YELLOW}üì¶ Installing Composer dependencies...${NC}"
          if COMPOSER_ALLOW_SUPERUSER=1 composer install --no-dev --prefer-dist --no-progress --no-interaction 2> composer-warnings.log; then
            echo -e "${GREEN}‚úÖ Composer installed${NC}"
          else
            echo -e "${RED}‚ùå Composer install failed! Check composer-warnings.log${NC}"
            exit 1
          fi

          # --- Build theme ---
          echo -e "${YELLOW}üèó Building theme...${NC}"
          if npm run build 2> build-warnings.log; then
            echo -e "${GREEN}‚úÖ Theme built${NC}"
          else
            echo -e "${RED}‚ùå Theme build failed! Check build-warnings.log${NC}"
            exit 1
          fi

          # --- Permissions ---
          echo -e "${YELLOW}üîß Fixing permissions...${NC}"
          find . -type d -exec chmod 755 {} \;
          find . -type f -exec chmod 644 {} \;

          echo -e "${GREEN}üéâ Deployment completed at $(date)${NC}"
          echo -e "${YELLOW}‚ö†Ô∏è Warnings (if any) saved to npm-warnings.log, composer-warnings.log, build-warnings.log${NC}"
